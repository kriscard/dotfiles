#!/usr/bin/env bash
cd ~/Code/roofr-dev/roofr || return
WORKTREE=$(gum input --placeholder "Worktree name (keep it short)")
if [[ -z "$WORKTREE" ]]; then
  echo "Worktree name cannot be empty."
  exit 1
fi
git worktree add "worktrees/$WORKTREE" -b "$WORKTREE" --no-track origin/staging

cd "worktrees/$WORKTREE" || return

# Get session name from directory
SESSION_NAME=$(basename "$PWD")

# Create or attach to session with proper window setup
if ! tmux has-session -t "$SESSION_NAME" 2>/dev/null; then
  # Create new session in detached mode
  tmux new-session -d -s "$SESSION_NAME" -c "$PWD"
  # Create roofr-dev window and run setup
  tmux new-window -t "$SESSION_NAME" -n "roofr-dev" -c "$PWD" "roofr_setup"
  # Select first window (use 1 if base-index is 1)
  tmux select-window -t "$SESSION_NAME:1"
fi

# Switch or attach depending on whether we're in tmux
if [ -n "$TMUX" ]; then
  tmux switch-client -t "$SESSION_NAME"
else
  tmux attach -t "$SESSION_NAME"
fi
